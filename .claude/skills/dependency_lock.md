# Skill: dependency_lock

## Description
Lock dependencies with UV.

## Instructions
This skill manages Python dependencies using UV (ultra-fast Python package installer and resolver), including dependency locking, syncing, updating, and best practices for reproducible builds.

## UV Overview

UV is a modern, extremely fast Python package installer and resolver written in Rust. It's designed to replace pip, pip-tools, and virtualenv with a single tool.

**Key Benefits:**
- 10-100x faster than pip
- Built-in dependency resolution
- Lock file support (uv.lock)
- Virtual environment management
- Compatible with pip and requirements.txt
- Built-in workspace support

## Installation

### Install UV
```bash
# macOS/Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# Windows
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"

# With pip
pip install uv

# Verify installation
uv --version
```

## Basic Workflow

### 1. Initialize Project
```bash
# Create new project
uv init

# Create new project with specific Python version
uv init --python 3.11

# Initialize in existing directory
uv init --name my-project
```

### 2. Add Dependencies
```bash
# Add a dependency
uv add fastapi

# Add with version constraint
uv add "fastapi>=0.104.0"

# Add dev dependency
uv add --dev pytest

# Add multiple dependencies
uv add fastapi uvicorn sqlalchemy

# Add from git
uv add git+https://github.com/user/repo.git

# Add with extras
uv add "fastapi[all]"
```

### 3. Lock Dependencies
```bash
# Generate/update lock file
uv lock

# Lock with specific Python version
uv lock --python-version 3.11

# Update specific package
uv lock --upgrade-package fastapi

# Dry run (show what would change)
uv lock --dry-run
```

### 4. Install/Sync Dependencies
```bash
# Sync environment with lock file
uv sync

# Install without dev dependencies
uv sync --no-dev

# Install only dev dependencies
uv sync --only-dev

# Install all extras
uv sync --all-extras

# Install specific extra
uv sync --extra dev
```

### 5. Update Dependencies
```bash
# Update all dependencies
uv lock --upgrade

# Update specific package
uv lock --upgrade-package fastapi

# Update multiple packages
uv lock --upgrade-package fastapi --upgrade-package uvicorn

# Update within constraints
uv lock --upgrade
```

## Project Structure

### pyproject.toml
```toml
[project]
name = "my-app"
version = "0.1.0"
description = "My application"
readme = "README.md"
requires-python = ">=3.11"
dependencies = [
    "fastapi>=0.104.0",
    "uvicorn>=0.24.0",
    "sqlalchemy>=2.0.0",
    "pydantic>=2.0.0",
    "pydantic-settings>=2.0.0"
]

[project.optional-dependencies]
dev = [
    "pytest>=7.4.0",
    "pytest-cov>=4.1.0",
    "mypy>=1.7.0",
    "ruff>=0.1.0",
    "black>=23.0.0"
]
test = [
    "pytest>=7.4.0",
    "pytest-asyncio>=0.21.0",
    "httpx>=0.25.0"
]
docs = [
    "mkdocs>=1.5.0",
    "mkdocs-material>=9.4.0"
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.uv]
dev-dependencies = [
    "ipython>=8.17.0",
    "pytest-watch>=4.2.0"
]

# Constraint versions
[tool.uv.sources]
# Use specific git branch
my-package = { git = "https://github.com/user/repo", branch = "main" }

# Use local path (for development)
# my-package = { path = "../my-package", editable = true }
```

### uv.lock
The lock file is automatically generated and should be committed to version control.

```toml
# This file is automatically @generated by uv.
# It is not intended for manual editing.
version = 1
requires-python = ">=3.11"

[[package]]
name = "fastapi"
version = "0.104.1"
source = { registry = "https://pypi.org/simple" }
dependencies = [
    { name = "pydantic" },
    { name = "starlette" },
]
wheels = [
    { url = "https://files.pythonhosted.org/...", hash = "sha256:..." },
]

[[package]]
name = "pydantic"
version = "2.5.0"
...
```

## Advanced Usage

### Workspace Management

For monorepos with multiple Python packages:

#### Root pyproject.toml
```toml
[tool.uv.workspace]
members = ["packages/*"]

[tool.uv.sources]
api = { workspace = true }
shared = { workspace = true }
cli = { workspace = true }
```

#### Package pyproject.toml (packages/api/pyproject.toml)
```toml
[project]
name = "api"
version = "0.1.0"
requires-python = ">=3.11"
dependencies = [
    "fastapi>=0.104.0",
    "shared"  # References workspace package
]
```

### Dependency Groups

```toml
[dependency-groups]
dev = [
    "pytest>=7.4.0",
    "mypy>=1.7.0"
]
test = [
    "pytest>=7.4.0",
    "pytest-cov>=4.1.0"
]
lint = [
    "ruff>=0.1.0",
    "black>=23.0.0"
]
```

Install specific groups:
```bash
uv sync --group dev
uv sync --group test --group lint
```

### Virtual Environment Management

```bash
# Create virtual environment
uv venv

# Create with specific Python version
uv venv --python 3.11

# Create in custom location
uv venv .venv

# Activate environment
source .venv/bin/activate  # Unix
.venv\Scripts\activate     # Windows

# Run command in environment without activation
uv run python script.py
uv run pytest
```

### Running Commands

```bash
# Run Python script
uv run python main.py

# Run module
uv run -m pytest

# Run with inline dependencies
uv run --with httpx python script.py

# Run with specific Python version
uv run --python 3.11 python script.py
```

### Exporting Lock File

```bash
# Export to requirements.txt format
uv export --format requirements-txt > requirements.txt

# Export without hashes
uv export --format requirements-txt --no-hashes > requirements.txt

# Export dev dependencies
uv export --format requirements-txt --group dev > requirements-dev.txt

# Export for specific platform
uv export --format requirements-txt --python-platform linux > requirements.txt
```

## Lock File Best Practices

### 1. Always Commit Lock File
```bash
git add uv.lock
git commit -m "Update dependencies"
```

### 2. Regenerate Lock File Regularly
```bash
# Weekly or after dependency changes
uv lock
```

### 3. Pin Critical Dependencies
```toml
[project]
dependencies = [
    "fastapi==0.104.1",  # Exact version for stability
    "uvicorn>=0.24.0,<0.25.0",  # Range for flexibility
]
```

### 4. Separate Dev Dependencies
```toml
[dependency-groups]
dev = [
    "pytest>=7.4.0",
    "black>=23.0.0"
]
```

### 5. Use Dependency Groups for Optional Features
```toml
[dependency-groups]
postgres = ["psycopg2-binary>=2.9.0"]
redis = ["redis>=5.0.0"]
all = ["psycopg2-binary>=2.9.0", "redis>=5.0.0"]
```

## Security and Auditing

### Audit Dependencies
```bash
# Check for known vulnerabilities
uv pip list --format json | python -m json.tool

# Use with safety or pip-audit
uv export --format requirements-txt | safety check --stdin
```

### Update Security Patches
```bash
# Update all packages
uv lock --upgrade

# Update specific vulnerable package
uv lock --upgrade-package vulnerable-package
```

## CI/CD Integration

### GitHub Actions
```yaml
name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run tests
        run: uv run pytest

      - name: Run linter
        run: uv run ruff check .

      - name: Type check
        run: uv run mypy src/
```

### GitLab CI
```yaml
test:
  image: python:3.11
  before_script:
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - source $HOME/.cargo/env
  script:
    - uv sync --all-extras --dev
    - uv run pytest
    - uv run ruff check .
  cache:
    paths:
      - .venv/
```

### Docker Integration
```dockerfile
FROM python:3.11-slim

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Set working directory
WORKDIR /app

# Copy dependency files
COPY pyproject.toml uv.lock ./

# Install dependencies
RUN uv sync --frozen --no-cache

# Copy application code
COPY . .

# Run application
CMD ["uv", "run", "python", "main.py"]
```

### Multi-stage Docker Build
```dockerfile
# Build stage
FROM python:3.11-slim AS builder

COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

WORKDIR /app
COPY pyproject.toml uv.lock ./
RUN uv sync --frozen --no-dev --no-cache

# Runtime stage
FROM python:3.11-slim

WORKDIR /app
COPY --from=builder /app/.venv /app/.venv
COPY . .

ENV PATH="/app/.venv/bin:$PATH"
CMD ["python", "main.py"]
```

## Migration from Other Tools

### From requirements.txt
```bash
# Import requirements.txt
uv pip install -r requirements.txt

# Generate pyproject.toml and lock file
uv init
uv add $(cat requirements.txt)
```

### From Poetry
```bash
# Convert poetry.lock to uv.lock
uv lock

# Or manually migrate pyproject.toml
# Poetry and uv use similar format, minor adjustments needed
```

### From Pipenv
```bash
# Export Pipfile.lock to requirements.txt
pipenv requirements > requirements.txt

# Import into uv
uv add $(cat requirements.txt)
```

## Troubleshooting

### Common Issues

**Lock File Conflicts:**
```bash
# Regenerate lock file
rm uv.lock
uv lock
```

**Dependency Resolution Errors:**
```bash
# Show resolution details
uv lock --verbose

# Relax constraints
# Edit pyproject.toml to use wider version ranges
```

**Platform-Specific Dependencies:**
```bash
# Lock for specific platform
uv lock --python-platform linux

# Lock for multiple platforms
uv lock --python-platform linux --python-platform darwin
```

**Cache Issues:**
```bash
# Clear cache
uv cache clean

# Show cache location
uv cache dir
```

## Performance Optimization

### 1. Use Lock File in CI
```bash
# Don't resolve, just install from lock
uv sync --frozen
```

### 2. Cache Virtual Environment
```yaml
# GitHub Actions
- uses: actions/cache@v3
  with:
    path: .venv
    key: venv-${{ hashFiles('uv.lock') }}
```

### 3. Parallel Installation
UV automatically parallelizes downloads and installations.

### 4. Local Package Index
```bash
# Use local PyPI mirror
uv sync --index-url http://localhost:8080/simple
```

## Usage Examples

### Lock Dependencies
```
dependency_lock lock
```

### Update Dependencies
```
dependency_lock update
dependency_lock update --package fastapi
```

### Sync Environment
```
dependency_lock sync
dependency_lock sync --no-dev
```

### Export Lock File
```
dependency_lock export --format requirements.txt
```

### Audit Dependencies
```
dependency_lock audit
```

## Output

The skill will:
1. Generate or update uv.lock file
2. Resolve all dependencies with exact versions
3. Validate lock file integrity
4. Report any conflicts or issues
5. Show dependency tree (if requested)
6. Export to other formats (if requested)

## Best Practices Summary

1. **Always commit uv.lock** to version control
2. **Use `uv sync --frozen` in CI/CD** for reproducible builds
3. **Update regularly** but test thoroughly
4. **Separate dev dependencies** from production
5. **Pin critical versions** for stability
6. **Use dependency groups** for optional features
7. **Audit security** regularly
8. **Cache appropriately** in CI/CD
9. **Document custom sources** in pyproject.toml
10. **Test across platforms** when needed

## UV vs Other Tools

| Feature | UV | pip | Poetry | PDM |
|---------|----|----|--------|-----|
| Speed | ⚡⚡⚡ | ⚡ | ⚡⚡ | ⚡⚡ |
| Lock file | ✅ | ❌ | ✅ | ✅ |
| Resolver | ✅ | ⚠️ | ✅ | ✅ |
| Workspace | ✅ | ❌ | ❌ | ✅ |
| Venv mgmt | ✅ | ❌ | ✅ | ✅ |
| PEP 621 | ✅ | ❌ | ⚠️ | ✅ |

## Notes

- UV is designed for speed without sacrificing correctness
- Lock file ensures reproducible installations across environments
- Compatible with standard Python packaging (PEP 621)
- Can coexist with other tools (pip, poetry) during migration
- Automatic virtual environment management simplifies workflow
- Built-in workspace support for monorepos
- Regular updates improve performance and add features
